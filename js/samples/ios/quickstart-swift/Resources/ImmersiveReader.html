<!-- Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the MIT License. -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script type="text/javascript" src="https://ircdname.azureedge.net/immersivereadersdk/immersive-reader-sdk.1.2.0.js"></script>
    <script type="text/javascript">
        let handleError = (error, caller) => {

            let alertMessage = `Error in ${caller === 'token' ? 'getting the Immersive Reader token' : 'launching the Immersive Reader'}. Check the console.`
            let errorStatus = error.status ?? 'unknown';
            let errorStatusText = error.statusText ?? 'unknown';
            let errorMessage = error.message ?? 'unknown';
            let errorSessionId = error.sessionId ?? 'unknown'; // Customers can report this sessionId to Immersive Reader team for further debugging.
            let errorMessageToLog = `Error - Status: ${errorStatus}, StatusText: ${errorStatusText}, Message: ${errorMessage}, SessionId: ${errorSessionId}`;

            console.log(errorMessageToLog);

            alert(alertMessage);
        }

        function launchImmersiveReader(message) {
            if (!message) {
                window.webkit.messageHandlers.invalidMessagePassed.postMessage(null);
                // handle message is not defined or when message is null
            } else {
                if (typeof message.options == "undefined") {
                    message.options = {}
                }
                message.options.onExit = function() {
                    window.webkit.messageHandlers.onExit.postMessage(null);
                }
                message.options.onPreferencesChanged = function(value) {
                    window.webkit.messageHandlers.onPreferencesChanged.postMessage(value);
                }
                // Use the JavaScript SDK to launch the Immersive Reader.
                ImmersiveReader.launchAsync(message.cogSvcsAccessToken, message.cogSvcsSubdomain, message.content, message.options)
                    .catch(error => handleError(error, 'launch'));
            }
        }
        window.addEventListener("message",
            function(message) {
                if (message.data == "ImmersiveReader-ReadyForContent") {
                    window.webkit.messageHandlers.readyForContent.postMessage(null);
                }
                if (message.data == "ImmersiveReader-LaunchSuccessful") {
                    window.webkit.messageHandlers.launchSuccessful.postMessage(null);
                }
                if (message.data == "ImmersiveReader-TokenExpired") {
                    window.webkit.messageHandlers.tokenExpired.postMessage(null);
                }
                if (message.data == "ImmersiveReader-Throttled") {
                    window.webkit.messageHandlers.throttled.postMessage(null);
                }
        });
    </script>
</head>
</html>
